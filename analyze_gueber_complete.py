"""
An√°lisis completo de parametrizaci√≥n del plan de cuentas para GUEBER
Validaci√≥n exhaustiva de toda la configuraci√≥n contable
"""

import os
import django
import sys

# Configurar Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'contaec.settings')
django.setup()

from apps.companies.models import Company, CompanyAccountDefaults, CompanyTaxAccountMapping, PaymentMethod
from apps.accounting.models import ChartOfAccounts, JournalEntry, JournalEntryLine
from apps.accounting.services import AutomaticJournalEntryService
from apps.invoicing.models import Customer
from decimal import Decimal

def analyze_gueber_chart_of_accounts():
    """An√°lisis completo del plan de cuentas de GUEBER"""
    print("üè¢ AN√ÅLISIS COMPLETO DEL PLAN DE CUENTAS - GUEBER")
    print("=" * 80)
    
    # Obtener empresa GUEBER
    gueber = Company.objects.filter(trade_name__icontains='GUEBER').first()
    if not gueber:
        print("‚ùå Empresa GUEBER no encontrada")
        return False
    
    print(f"üìã Empresa: {gueber.trade_name} (ID: {gueber.id})")
    print(f"üìß Email: {gueber.email}")
    print(f"üÜî RUC: {getattr(gueber, 'ruc', 'No disponible')}")
    
    errors = []
    warnings = []
    recommendations = []
    
    # ==========================================
    # 1. ESTRUCTURA DEL PLAN DE CUENTAS
    # ==========================================
    print(f"\\n1Ô∏è‚É£ ESTRUCTURA DEL PLAN DE CUENTAS")
    print("-" * 60)
    
    total_accounts = ChartOfAccounts.objects.filter(company=gueber).count()
    active_accounts = ChartOfAccounts.objects.filter(company=gueber, is_active=True).count()
    movement_accounts = ChartOfAccounts.objects.filter(company=gueber, accepts_movement=True).count()
    
    print(f"üìä Total cuentas: {total_accounts}")
    print(f"üìä Cuentas activas: {active_accounts}")
    print(f"üìä Cuentas que aceptan movimiento: {movement_accounts}")
    
    if total_accounts == 0:
        errors.append("No hay cuentas en el plan de cuentas")
    elif total_accounts < 20:
        warnings.append(f"Plan de cuentas muy b√°sico ({total_accounts} cuentas)")
    
    # Verificar estructura por niveles
    print(f"\\nüìà Estructura por niveles:")
    for level in range(1, 6):
        level_accounts = ChartOfAccounts.objects.filter(
            company=gueber, 
            level=level
        ).count()
        print(f"   Nivel {level}: {level_accounts} cuentas")
    
    # ==========================================
    # 2. CONFIGURACI√ìN DE DEFAULTS
    # ==========================================
    print(f"\\n2Ô∏è‚É£ CONFIGURACI√ìN DE CUENTAS POR DEFECTO")
    print("-" * 60)
    
    defaults = CompanyAccountDefaults.objects.filter(company=gueber).first()
    if defaults:
        print("‚úÖ CompanyAccountDefaults configurado")
        
        # Verificar cuenta de ventas
        if defaults.default_sales_account:
            sales_account = defaults.default_sales_account
            print(f"   üí∞ Ventas: {sales_account.code} - {sales_account.name}")
            if not sales_account.is_active:
                errors.append(f"Cuenta de ventas {sales_account.code} est√° inactiva")
            if not sales_account.accepts_movement:
                errors.append(f"Cuenta de ventas {sales_account.code} no acepta movimientos")
            if not sales_account.code.startswith('4'):
                warnings.append(f"Cuenta de ventas {sales_account.code} no sigue patr√≥n t√≠pico de ingresos (4.x)")
        else:
            errors.append("Cuenta de ventas por defecto no configurada")
        
        # Verificar cuenta retenci√≥n IVA
        if defaults.iva_retention_receivable_account:
            iva_ret_account = defaults.iva_retention_receivable_account
            print(f"   üßæ Retenci√≥n IVA: {iva_ret_account.code} - {iva_ret_account.name}")
            if not iva_ret_account.is_active:
                errors.append(f"Cuenta retenci√≥n IVA {iva_ret_account.code} est√° inactiva")
            if not iva_ret_account.accepts_movement:
                errors.append(f"Cuenta retenci√≥n IVA {iva_ret_account.code} no acepta movimientos")
            if not iva_ret_account.code.startswith('1.1'):
                warnings.append(f"Cuenta retenci√≥n IVA {iva_ret_account.code} no sigue patr√≥n t√≠pico (1.1.x)")
        else:
            errors.append("Cuenta retenci√≥n IVA por defecto no configurada")
        
        # Verificar cuenta retenci√≥n IR
        if defaults.ir_retention_receivable_account:
            ir_ret_account = defaults.ir_retention_receivable_account
            print(f"   üìÑ Retenci√≥n IR: {ir_ret_account.code} - {ir_ret_account.name}")
            if not ir_ret_account.is_active:
                errors.append(f"Cuenta retenci√≥n IR {ir_ret_account.code} est√° inactiva")
            if not ir_ret_account.accepts_movement:
                errors.append(f"Cuenta retenci√≥n IR {ir_ret_account.code} no acepta movimientos")
            if not ir_ret_account.code.startswith('1.1'):
                warnings.append(f"Cuenta retenci√≥n IR {ir_ret_account.code} no sigue patr√≥n t√≠pico (1.1.x)")
        else:
            errors.append("Cuenta retenci√≥n IR por defecto no configurada")
    else:
        errors.append("CompanyAccountDefaults no configurado")
    
    # ==========================================
    # 3. MAPEO DE CUENTAS IVA
    # ==========================================
    print(f"\\n3Ô∏è‚É£ MAPEO DE CUENTAS IVA")
    print("-" * 60)
    
    iva_mappings = CompanyTaxAccountMapping.objects.filter(company=gueber).order_by('tax_rate')
    
    expected_rates = [Decimal('0.00'), Decimal('5.00'), Decimal('12.00'), Decimal('15.00')]
    print(f"üìã Mapeos configurados: {iva_mappings.count()}")
    
    for rate in expected_rates:
        mapping = iva_mappings.filter(tax_rate=rate).first()
        if mapping:
            account = mapping.account
            ret_account = mapping.retention_account
            
            status_account = "‚úÖ" if account.is_active and account.accepts_movement else "‚ùå"
            status_ret = "‚úÖ" if ret_account and ret_account.is_active and ret_account.accepts_movement else "‚ùå"
            
            print(f"   IVA {rate:5.1f}%: {account.code} {status_account}")
            if ret_account:
                print(f"              Ret: {ret_account.code} {status_ret}")
            else:
                print(f"              Ret: No configurada ‚ö†Ô∏è")
            
            # Validaciones
            if not account.is_active:
                errors.append(f"Cuenta IVA {rate}% ({account.code}) est√° inactiva")
            if not account.accepts_movement:
                errors.append(f"Cuenta IVA {rate}% ({account.code}) no acepta movimientos")
            if rate > 0 and not account.code.startswith('2.1'):
                warnings.append(f"Cuenta IVA {rate}% ({account.code}) no sigue patr√≥n t√≠pico (2.1.x)")
            
            if rate > 0 and not ret_account:
                warnings.append(f"Cuenta retenci√≥n IVA {rate}% no configurada")
            elif ret_account:
                if not ret_account.is_active:
                    errors.append(f"Cuenta retenci√≥n IVA {rate}% ({ret_account.code}) est√° inactiva")
                if not ret_account.accepts_movement:
                    errors.append(f"Cuenta retenci√≥n IVA {rate}% ({ret_account.code}) no acepta movimientos")
        else:
            if rate == Decimal('0.00'):
                warnings.append(f"Mapeo IVA {rate}% no configurado (opcional)")
            else:
                errors.append(f"Mapeo IVA {rate}% no configurado")
    
    # ==========================================
    # 4. CONSISTENCIA ENTRE CONFIGURACIONES
    # ==========================================
    print(f"\\n4Ô∏è‚É£ CONSISTENCIA ENTRE CONFIGURACIONES")
    print("-" * 60)
    
    if defaults and defaults.iva_retention_receivable_account:
        default_iva_ret = defaults.iva_retention_receivable_account.code
        
        # Verificar que todas las retenciones IVA apunten a la misma cuenta
        retention_accounts = set()
        for mapping in iva_mappings:
            if mapping.retention_account:
                retention_accounts.add(mapping.retention_account.code)
        
        if len(retention_accounts) == 0:
            warnings.append("No hay cuentas de retenci√≥n IVA configuradas en mapeos")
        elif len(retention_accounts) == 1:
            mapping_iva_ret = list(retention_accounts)[0]
            if default_iva_ret == mapping_iva_ret:
                print(f"‚úÖ Consistencia retenci√≥n IVA: {default_iva_ret}")
            else:
                errors.append(f"Inconsistencia retenci√≥n IVA: Default={default_iva_ret} vs Mapeo={mapping_iva_ret}")
        else:
            errors.append(f"M√∫ltiples cuentas de retenci√≥n IVA: {retention_accounts}")
    
    # ==========================================
    # 5. VERIFICACI√ìN DE CUENTAS CR√çTICAS
    # ==========================================
    print(f"\\n5Ô∏è‚É£ VERIFICACI√ìN DE CUENTAS CR√çTICAS")
    print("-" * 60)
    
    critical_patterns = [
        ('1.1', 'Activo Corriente'),
        ('1.2', 'Activo No Corriente'),
        ('2.1', 'Pasivo Corriente'),
        ('2.2', 'Pasivo No Corriente'),
        ('3.', 'Patrimonio'),
        ('4.', 'Ingresos'),
        ('5.', 'Gastos'),
        ('6.', 'Costos')
    ]
    
    for pattern, description in critical_patterns:
        count = ChartOfAccounts.objects.filter(
            company=gueber,
            code__startswith=pattern,
            is_active=True
        ).count()
        
        status = "‚úÖ" if count > 0 else "‚ö†Ô∏è"
        print(f"   {description} ({pattern}*): {count} cuentas {status}")
        
        if count == 0:
            warnings.append(f"No hay cuentas de {description}")
    
    # ==========================================
    # 6. M√âTODO DE PAGO CONFIGURADO
    # ==========================================
    print(f"\\n6Ô∏è‚É£ M√âTODO DE PAGO CONFIGURADO")
    print("-" * 60)
    
    if gueber.payment_method:
        payment_method = gueber.payment_method
        print(f"‚úÖ M√©todo de pago: {payment_method.name}")
        
        if payment_method.parent_account:
            account = payment_method.parent_account
            print(f"   üí≥ Cuenta asociada: {account.code} - {account.name}")
            
            if not account.is_active:
                errors.append(f"Cuenta m√©todo de pago {account.code} est√° inactiva")
            if not account.accepts_movement:
                errors.append(f"Cuenta m√©todo de pago {account.code} no acepta movimientos")
        else:
            warnings.append("M√©todo de pago sin cuenta asociada")
    else:
        errors.append("M√©todo de pago no configurado")
    
    # ==========================================
    # 7. PRUEBAS DE INTEGRACI√ìN
    # ==========================================
    print(f"\\n7Ô∏è‚É£ PRUEBAS DE INTEGRACI√ìN CON SERVICIOS")
    print("-" * 60)
    
    # Probar servicio de cuentas de ventas
    sales_account_service = AutomaticJournalEntryService._get_sales_account(gueber)
    if sales_account_service:
        print(f"‚úÖ Servicio ventas: {sales_account_service.code}")
    else:
        errors.append("Servicio de cuentas de ventas falla")
    
    # Probar servicio de cuentas IVA
    test_rates = [5.0, 12.0, 15.0]
    for rate in test_rates:
        iva_account_service = AutomaticJournalEntryService._get_iva_account(gueber, rate)
        if iva_account_service:
            print(f"‚úÖ Servicio IVA {rate:4.1f}%: {iva_account_service.code}")
        else:
            errors.append(f"Servicio de cuentas IVA {rate}% falla")
    
    # Probar servicio de retenciones
    iva_ret_service = AutomaticJournalEntryService._get_iva_retention_receivable_account(gueber, 15.0)
    if iva_ret_service:
        print(f"‚úÖ Servicio retenci√≥n IVA: {iva_ret_service.code}")
    else:
        errors.append("Servicio de retenci√≥n IVA falla")
    
    ir_ret_service = AutomaticJournalEntryService._get_ir_retention_receivable_account(gueber)
    if ir_ret_service:
        print(f"‚úÖ Servicio retenci√≥n IR: {ir_ret_service.code}")
    else:
        errors.append("Servicio de retenci√≥n IR falla")
    
    # ==========================================
    # 8. AN√ÅLISIS DE MOVIMIENTOS EXISTENTES
    # ==========================================
    print(f"\\n8Ô∏è‚É£ AN√ÅLISIS DE MOVIMIENTOS CONTABLES")
    print("-" * 60)
    
    journal_entries = JournalEntry.objects.filter(company=gueber).count()
    journal_lines = JournalEntryLine.objects.filter(
        journal_entry__company=gueber
    ).count()
    
    print(f"üìä Asientos contables: {journal_entries}")
    print(f"üìä L√≠neas de asiento: {journal_lines}")
    
    if journal_entries > 0:
        # Verificar balance
        total_debits = JournalEntryLine.objects.filter(
            journal_entry__company=gueber
        ).aggregate(total=django.db.models.Sum('debit'))['total'] or Decimal('0')
        
        total_credits = JournalEntryLine.objects.filter(
            journal_entry__company=gueber
        ).aggregate(total=django.db.models.Sum('credit'))['total'] or Decimal('0')
        
        balance_diff = abs(total_debits - total_credits)
        
        print(f"üí∞ Total d√©bitos: ${total_debits:,.2f}")
        print(f"üí∞ Total cr√©ditos: ${total_credits:,.2f}")
        print(f"‚öñÔ∏è Diferencia: ${balance_diff:,.2f}")
        
        if balance_diff > Decimal('0.01'):
            errors.append(f"Asientos desbalanceados: diferencia ${balance_diff}")
        else:
            print("‚úÖ Asientos balanceados correctamente")
    
    # ==========================================
    # 9. CLIENTES CON RETENCI√ìN
    # ==========================================
    print(f"\\n9Ô∏è‚É£ CLIENTES CON CONFIGURACI√ìN DE RETENCI√ìN")
    print("-" * 60)
    
    total_customers = Customer.objects.filter(company=gueber).count()
    retention_customers = Customer.objects.filter(
        company=gueber, 
        retention_agent=True
    ).count()
    
    print(f"üë• Total clientes: {total_customers}")
    print(f"üèõÔ∏è Clientes agentes de retenci√≥n: {retention_customers}")
    
    if retention_customers > 0:
        print("   üìã Clientes configurados para retenci√≥n:")
        for customer in Customer.objects.filter(company=gueber, retention_agent=True)[:5]:
            rates = customer.get_retention_rates()
            print(f"      ‚Ä¢ {customer.trade_name or customer.legal_name}")
            print(f"        IVA: {rates['iva_retention']}% | IR: {rates['ir_retention']}%")
    
    # ==========================================
    # 10. RESUMEN Y RECOMENDACIONES
    # ==========================================
    print(f"\\nüéØ RESUMEN DEL AN√ÅLISIS")
    print("=" * 80)
    
    print(f"\\n‚ùå ERRORES CR√çTICOS ({len(errors)}):")
    for i, error in enumerate(errors, 1):
        print(f"   {i}. {error}")
    
    print(f"\\n‚ö†Ô∏è ADVERTENCIAS ({len(warnings)}):")
    for i, warning in enumerate(warnings, 1):
        print(f"   {i}. {warning}")
    
    # Generar recomendaciones autom√°ticas
    if len(errors) == 0 and len(warnings) <= 2:
        recommendations.append("Configuraci√≥n √≥ptima para operaciones contables")
        recommendations.append("Sistema listo para generar asientos autom√°ticos")
    
    if len(errors) > 0:
        recommendations.append("Corregir errores cr√≠ticos antes de usar sistema")
        recommendations.append("Revisar configuraci√≥n de cuentas inactivas")
    
    if retention_customers == 0:
        recommendations.append("Configurar clientes como agentes de retenci√≥n seg√∫n SRI")
    
    if journal_entries == 0:
        recommendations.append("Generar facturas de prueba para validar configuraci√≥n")
    
    print(f"\\nüí° RECOMENDACIONES ({len(recommendations)}):")
    for i, rec in enumerate(recommendations, 1):
        print(f"   {i}. {rec}")
    
    # Puntuaci√≥n final
    total_issues = len(errors) + len(warnings)
    if len(errors) == 0 and len(warnings) == 0:
        score = "üü¢ EXCELENTE"
        score_text = "Configuraci√≥n perfecta"
    elif len(errors) == 0 and len(warnings) <= 3:
        score = "üü° MUY BUENO"
        score_text = "Configuraci√≥n funcional con mejoras menores"
    elif len(errors) <= 2:
        score = "üü† BUENO"
        score_text = "Configuraci√≥n funcional con correcciones necesarias"
    else:
        score = "üî¥ REQUIERE ATENCI√ìN"
        score_text = "Configuraci√≥n con problemas cr√≠ticos"
    
    print(f"\\nüìä PUNTUACI√ìN GENERAL: {score}")
    print(f"üìù {score_text}")
    
    return len(errors) == 0

if __name__ == "__main__":
    import django.db.models
    success = analyze_gueber_chart_of_accounts()
    sys.exit(0 if success else 1)
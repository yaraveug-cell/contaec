{% extends 'base.html' %}
{% load static %}

{% block title %}Extracto de Conciliación Mensual{% endblock %}

{% block extra_css %}
<link href="{% static 'css/banking.css' %}" rel="stylesheet">
<style>
.reporte-header {
    background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.selectors-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border-left: 5px solid #6f42c1;
}

.resumen-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border-left: 5px solid #28a745;
}

.saldos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.saldo-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1.5rem;
    border-radius: 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.saldo-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--color, #007bff);
}

.saldo-inicial::before { --color: #6c757d; }
.saldo-sistema::before { --color: #007bff; }
.saldo-extracto::before { --color: #17a2b8; }
.saldo-diferencia::before { --color: #ffc107; }

.saldo-numero {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.diferencia-positiva {
    color: #28a745;
}

.diferencia-negativa {
    color: #dc3545;
}

.diferencia-cero {
    color: #6c757d;
}

.movimientos-tabla {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.tabla-header {
    background: linear-gradient(45deg, #495057, #6c757d);
    color: white;
    padding: 1rem;
}

.movimiento-row {
    border-bottom: 1px solid #e9ecef;
    padding: 0.75rem;
    transition: background-color 0.3s ease;
}

.movimiento-row:hover {
    background-color: #f8f9fa;
}

.conciliado {
    background-color: #d4edda;
}

.no-conciliado {
    background-color: #f8d7da;
}

.badge-conciliado {
    background-color: #28a745;
}

.badge-no-conciliado {
    background-color: #dc3545;
}

.btn-generar {
    background: linear-gradient(45deg, #6f42c1, #007bff);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    color: white;
    font-weight: 500;
}

.estadisticas-row {
    background: linear-gradient(45deg, #e9ecef, #f8f9fa);
    border-radius: 10px;
    padding: 1rem;
    margin: 1rem 0;
}

.porcentaje-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.porcentaje-fill {
    height: 100%;
    background: linear-gradient(45deg, #28a745, #20c997);
    transition: width 0.6s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header del Reporte -->
    <div class="reporte-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-calendar-alt me-3"></i>
                    Extracto de Conciliación Mensual
                </h1>
                <p class="mb-0 opacity-75">
                    Reporte detallado de conciliación bancaria por período
                </p>
            </div>
            <div class="text-end">
                <p class="mb-1">Generado el: <strong>{{ fecha_reporte|date:"d/m/Y H:i" }}</strong></p>
                {% if reporte_data %}
                <p class="mb-0">
                    Período: <strong>{{ reporte_data.periodo.inicio|date:"F Y" }}</strong>
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Selectores -->
    <div class="selectors-card">
        <h5 class="mb-3">
            <i class="fas fa-cogs me-2"></i>Parámetros del Reporte
        </h5>
        <form method="get" id="parametrosForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="cuenta" class="form-label">Cuenta Bancaria</label>
                    <select name="cuenta" id="cuenta" class="form-select" required>
                        <option value="">Seleccione una cuenta</option>
                        {% for cuenta in todas_las_cuentas %}
                        <option value="{{ cuenta.id }}" 
                                {% if cuenta.id == cuenta_seleccionada.id %}selected{% endif %}>
                            {{ cuenta.bank.name }} - {{ cuenta.masked_account_number }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="año" class="form-label">Año</label>
                    <select name="año" id="año" class="form-select" required>
                        {% for año in años_disponibles %}
                        <option value="{{ año }}" 
                                {% if año == año_seleccionado %}selected{% endif %}>
                            {{ año }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label for="mes" class="form-label">Mes</label>
                    <select name="mes" id="mes" class="form-select" required>
                        {% for mes_num, mes_nombre in meses_disponibles %}
                        <option value="{{ mes_num }}" 
                                {% if mes_num == mes_seleccionado %}selected{% endif %}>
                            {{ mes_nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-generar w-100">
                        <i class="fas fa-chart-line me-2"></i>Generar
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% if reporte_data %}
    <!-- Resumen General -->
    <div class="resumen-card">
        <div class="row">
            <div class="col-lg-8">
                <h5 class="mb-3">
                    <i class="fas fa-university me-2"></i>
                    {{ reporte_data.cuenta.bank.name }}
                </h5>
                <p class="text-muted mb-1">
                    <strong>Cuenta:</strong> {{ reporte_data.cuenta.masked_account_number }} | 
                    <strong>Tipo:</strong> {{ reporte_data.cuenta.get_account_type_display }}
                </p>
                <p class="text-muted mb-3">
                    <strong>Período:</strong> 
                    {{ reporte_data.periodo.inicio|date:"d" }} al {{ reporte_data.periodo.fin|date:"d" }} de {{ reporte_data.periodo.fin|date:"F Y" }}
                </p>

                <!-- Estadísticas de Conciliación -->
                <div class="estadisticas-row">
                    <div class="row text-center">
                        <div class="col-md-6">
                            <h6>Transacciones del Sistema</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ reporte_data.transacciones.stats.conciliadas_count }}/{{ reporte_data.transacciones.stats.total_count }} conciliadas</span>
                                <strong>{{ reporte_data.porcentaje_conciliacion_transacciones|floatformat:1 }}%</strong>
                            </div>
                            <div class="porcentaje-bar">
                                <div class="porcentaje-fill" data-width="{{ reporte_data.porcentaje_conciliacion_transacciones|default:0 }}"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Items del Extracto</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ reporte_data.extractos.stats.conciliados_count }}/{{ reporte_data.extractos.stats.total_count }} conciliados</span>
                                <strong>{{ reporte_data.porcentaje_conciliacion_extractos|floatformat:1 }}%</strong>
                            </div>
                            <div class="porcentaje-bar">
                                <div class="porcentaje-fill" data-width="{{ reporte_data.porcentaje_conciliacion_extractos|default:0 }}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <!-- Estado General -->
                {% if reporte_data.saldos.diferencia == 0 %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Cuenta Conciliada</strong><br>
                        No hay diferencias detectadas.
                    </div>
                {% elif reporte_data.saldos.diferencia %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Diferencia Detectada</strong><br>
                        Requiere revisión manual.
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Sin Extracto</strong><br>
                        No hay extracto disponible para comparar.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Saldos -->
        <div class="saldos-grid">
            <div class="saldo-item saldo-inicial">
                <div class="saldo-numero">${{ reporte_data.saldos.inicial|floatformat:2 }}</div>
                <div class="text-muted">Saldo Inicial</div>
                <small class="text-muted">{{ reporte_data.periodo.inicio|date:"d/m/Y" }}</small>
            </div>
            <div class="saldo-item saldo-sistema">
                <div class="saldo-numero text-primary">${{ reporte_data.saldos.final_sistema|floatformat:2 }}</div>
                <div class="text-muted">Saldo Sistema</div>
                <small class="text-muted">{{ reporte_data.periodo.fin|date:"d/m/Y" }}</small>
            </div>
            {% if reporte_data.saldos.final_extracto %}
            <div class="saldo-item saldo-extracto">
                <div class="saldo-numero text-info">${{ reporte_data.saldos.final_extracto|floatformat:2 }}</div>
                <div class="text-muted">Saldo Extracto</div>
                <small class="text-muted">{{ reporte_data.periodo.fin|date:"d/m/Y" }}</small>
            </div>
            {% endif %}
            {% if reporte_data.saldos.diferencia is not None %}
            <div class="saldo-item saldo-diferencia">
                <div class="saldo-numero {% if reporte_data.saldos.diferencia > 0 %}diferencia-positiva{% elif reporte_data.saldos.diferencia < 0 %}diferencia-negativa{% else %}diferencia-cero{% endif %}">
                    {% if reporte_data.saldos.diferencia >= 0 %}
                        +${{ reporte_data.saldos.diferencia|floatformat:2 }}
                    {% else %}
                        ${{ reporte_data.saldos.diferencia|floatformat:2 }}
                    {% endif %}
                </div>
                <div class="text-muted">Diferencia</div>
                <small class="text-muted">Extracto - Sistema</small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Movimientos del Sistema -->
    <div class="movimientos-tabla">
        <div class="tabla-header">
            <h5 class="mb-0">
                <i class="fas fa-exchange-alt me-2"></i>
                Transacciones del Sistema ({{ reporte_data.transacciones.stats.total_count }})
            </h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>Tipo</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Conciliado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaccion in reporte_data.transacciones.queryset %}
                    <tr class="movimiento-row {% if transaccion.is_reconciled %}conciliado{% else %}no-conciliado{% endif %}">
                        <td>{{ transaccion.transaction_date|date:"d/m/Y" }}</td>
                        <td>{{ transaccion.description|truncatechars:50 }}</td>
                        <td>{{ transaccion.get_transaction_type_display }}</td>
                        <td class="{% if transaccion.signed_amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ transaccion.signed_amount|floatformat:2 }}
                        </td>
                        <td>
                            {% if transaccion.is_reconciled %}
                                <span class="badge badge-conciliado">
                                    <i class="fas fa-check me-1"></i>Conciliado
                                </span>
                            {% else %}
                                <span class="badge badge-no-conciliado">
                                    <i class="fas fa-times me-1"></i>Pendiente
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if transaccion.reconciliation_date %}
                                {{ transaccion.reconciliation_date|date:"d/m/Y H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay transacciones en este período
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Items del Extracto -->
    {% if reporte_data.extractos.items %}
    <div class="movimientos-tabla">
        <div class="tabla-header">
            <h5 class="mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Items del Extracto ({{ reporte_data.extractos.stats.total_count }})
            </h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>Referencia</th>
                        <th>Débito</th>
                        <th>Crédito</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in reporte_data.extractos.items %}
                    <tr class="movimiento-row {% if item.is_reconciled %}conciliado{% else %}no-conciliado{% endif %}">
                        <td>{{ item.fecha|date:"d/m/Y" }}</td>
                        <td>{{ item.descripcion|truncatechars:50 }}</td>
                        <td>{{ item.referencia|default:"-" }}</td>
                        <td class="text-danger">
                            {% if item.debito %}${{ item.debito|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="text-success">
                            {% if item.credito %}${{ item.credito|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td>
                            {% if item.is_reconciled %}
                                <span class="badge badge-conciliado">
                                    <i class="fas fa-check me-1"></i>Conciliado
                                </span>
                            {% else %}
                                <span class="badge badge-no-conciliado">
                                    <i class="fas fa-times me-1"></i>Pendiente
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay items de extracto en este período
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Mensaje cuando no hay datos -->
    <div class="resumen-card text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5>Seleccione los parámetros</h5>
        <p class="text-muted">Complete la cuenta, año y mes para generar el reporte de conciliación mensual.</p>
    </div>
    {% endif %}
</div>

<script>
// Auto-submit cuando cambian los parámetros
document.getElementById('parametrosForm').addEventListener('change', function(e) {
    if (e.target.name === 'cuenta' && e.target.value) {
        // Auto-submit cuando se selecciona una cuenta
        this.submit();
    }
});

// Navegación rápida por meses
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        const mesSelect = document.getElementById('mes');
        const currentMes = parseInt(mesSelect.value);
        
        if (e.key === 'ArrowLeft' && currentMes > 1) {
            // Mes anterior
            mesSelect.value = currentMes - 1;
            document.getElementById('parametrosForm').submit();
        } else if (e.key === 'ArrowRight' && currentMes < 12) {
            // Mes siguiente
            mesSelect.value = currentMes + 1;
            document.getElementById('parametrosForm').submit();
        }
    }

    // Aplicar anchos dinámicos a las barras de porcentaje
    document.querySelectorAll('[data-width]').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        if (width !== null) {
            bar.style.width = width + '%';
        }
    });
});
</script>
{% endblock %}
from functools import wraps
from django.http import Http404
from django.shortcuts import redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from apps.companies.models import CompanyUs        }f require_company_access(allowed_roles=None):
    """
    Decorador que requiere que el usuario tenga acceso a al menos una empresa
    con uno de los roles especificados.
    
    Args:
        allowed_roles (list): Lista de roles permitidos ['owner', 'admin', 'accountant', 'employee', 'viewer']
                            Si es None, cualquier rol con empresa asignada es v√°lido.
    """
    if allowed_roles is None:
        allowed_roles = ['owner', 'admin', 'accountant', 'employee', 'viewer']
    
    def decorator(view_func):
        @wraps(view_func)
        @login_required
        def wrapper(request, *args, **kwargs):
            # Superusers y staff tienen acceso completo
            if request.user.is_superuser or request.user.is_staff:
                return view_func(request, *args, **kwargs)
            
            # Verificar si el usuario tiene empresas asignadas con roles permitidos
            user_companies = CompanyUser.objects.filter(
                user=request.user,
                role__in=allowed_roles
            )
            
            if not user_companies.exists():
                messages.error(
                    request, 
                    'No tienes permisos para acceder a este m√≥dulo. '
                    'Contacta al administrador si crees que esto es un error.'
                )
                return redirect('dashboard')
            
            # Agregar las empresas del usuario al contexto de la request
            request.user_companies = user_companies
            return view_func(request, *args, **kwargs)
        
        return wrapper
    return decorator


def require_accounting_access(view_func):
    """
    Decorador espec√≠fico para m√≥dulos de contabilidad.
    Requiere rol de contador, administrador o propietario.
    """
    return require_company_access(['accountant', 'admin', 'owner'])(view_func)


def require_admin_access(view_func):
    """
    Decorador espec√≠fico para m√≥dulos administrativos.
    Requiere rol de administrador o propietario.
    """
    return require_company_access(['admin', 'owner'])(view_func)


def require_owner_access(view_func):
    """
    Decorador espec√≠fico para funciones de propietario.
    Requiere rol de propietario √∫nicamente.
    """
    return require_company_access(['owner'])(view_func)


def get_user_companies_with_roles(user, required_roles=None):
    """
    Obtiene las empresas del usuario con los roles especificados.
    
    Args:
        user: Usuario de Django
        required_roles (list): Lista de roles requeridos. Si es None, obtiene todas.
    
    Returns:
        QuerySet de CompanyUser
    """
    if user.is_superuser or user.is_staff:
        # Superusers ven todas las empresas
        return CompanyUser.objects.all()
    
    if required_roles is None:
        required_roles = ['owner', 'admin', 'accountant', 'employee', 'viewer']
    
    return CompanyUser.objects.filter(
        user=user,
        role__in=required_roles
    ).select_related('company')


def user_has_module_access(user, module_name):
    """
    Verifica si un usuario tiene acceso a un m√≥dulo espec√≠fico.
    
    Args:
        user: Usuario de Django
        module_name (str): Nombre del m√≥dulo ('accounting', 'invoicing', 'inventory', etc.)
    
    Returns:
        bool: True si tiene acceso, False en caso contrario
    """
    if user.is_superuser or user.is_staff:
        return True
    
    user_companies = CompanyUser.objects.filter(user=user)
    if not user_companies.exists():
        return False
    
    user_roles = set(user_companies.values_list('role', flat=True))
    
    # Definir m√≥dulos por rol
    module_access = {
        'profile': ['owner', 'admin', 'accountant', 'employee', 'viewer'],
        'companies': ['owner', 'admin', 'accountant', 'employee', 'viewer'],
        'accounting': ['owner', 'admin', 'accountant'],
        'reports': ['owner', 'admin', 'accountant'],
        'invoicing': ['owner', 'admin'],
        'inventory': ['owner', 'admin'],
        'payroll': ['owner', 'admin', 'accountant'],
        'fixed_assets': ['owner', 'admin', 'accountant'],
        'company_users': ['owner', 'admin'],
        'banking': ['owner', 'admin', 'accountant'],

    }
    
    required_roles = module_access.get(module_name, [])
    return bool(user_roles.intersection(required_roles))


def get_available_modules(user):
    """
    Obtiene la lista de m√≥dulos disponibles para un usuario espec√≠fico.
    
    Args:
        user: Usuario de Django
    
    Returns:
        list: Lista de diccionarios con informaci√≥n de los m√≥dulos disponibles
    """
    modules = []
    
    # M√≥dulo de perfil para todos los usuarios autenticados
    if user.is_authenticated:
        modules.append({
            'name': 'Mi Perfil',
            'description': 'Gestionar informaci√≥n personal',
            'url': '/perfil/',
            'icon': 'üë§',
            'color': 'bg-blue-500',
            'key': 'profile'
        })
    
    # Si el usuario no tiene empresas asignadas, solo mostrar perfil
    # (excepto superusers y staff)
    if not user.is_superuser and not user.is_staff:
        user_companies = CompanyUser.objects.filter(user=user)
        if not user_companies.exists():
            return modules
    
    # Agregar m√≥dulos seg√∫n acceso
    module_definitions = [
        {
            'key': 'companies',
            'name': 'Empresas',
            'description': 'Ver informaci√≥n de mis empresas',
            'url': '/modulos/empresas/',
            'icon': 'üè¢',
            'color': 'bg-orange-500'
        },
        {
            'key': 'accounting',
            'name': 'Contabilidad',
            'description': 'Plan de cuentas, asientos contables',
            'url': '/modulos/contabilidad/',
            'icon': 'üìä',
            'color': 'bg-green-500'
        },
        {
            'key': 'reports',
            'name': 'Reportes',
            'description': 'Estados financieros y reportes',
            'url': '/modulos/reportes/',
            'icon': 'üìà',
            'color': 'bg-purple-500'
        },
        {
            'key': 'invoicing',
            'name': 'Facturaci√≥n',
            'description': 'Facturas y documentos tributarios',
            'url': '/modulos/facturacion/',
            'icon': 'üßæ',
            'color': 'bg-red-500'
        },
        {
            'key': 'inventory',
            'name': 'Inventarios',
            'description': 'Control de stock y productos',
            'url': '/modulos/inventarios/',
            'icon': 'üì¶',
            'color': 'bg-yellow-500'
        },
        {
            'key': 'payroll',
            'name': 'N√≥mina',
            'description': 'Gesti√≥n de empleados y pagos',
            'url': '/admin/payroll/employee/',
            'icon': 'üí∞',
            'color': 'bg-pink-500'
        },
        {
            'key': 'fixed_assets',
            'name': 'Activos Fijos',
            'description': 'Control de bienes y depreciaciones',
            'url': '/admin/fixed_assets/fixedasset/',
            'icon': 'üèóÔ∏è',
            'color': 'bg-teal-500'
        },
        {
            'key': 'company_users',
            'name': 'Usuarios de mi Empresa',
            'description': 'Gestionar usuarios de mis empresas',
            'url': '/admin/companies/companyuser/',
            'icon': 'üë•',
            'color': 'bg-indigo-400'
        },
        {
            'key': 'banking',
            'name': 'Bancos',
            'description': 'M√≥dulo integral de gesti√≥n bancaria',
            'url': '/banking/',
            'icon': 'üè¶',
            'color': 'bg-emerald-500'
        },

        {
            'key': 'bank_statements',
            'name': 'Gesti√≥n de Cuentas',
            'description': 'Administrar cuentas y extractos bancarios',
            'url': '/admin/banking/bankaccount/',
            'icon': 'ÔøΩ',
            'color': 'bg-violet-500'
        }
    ]
    
    for module_def in module_definitions:
        if user_has_module_access(user, module_def['key']):
            modules.append(module_def)
    
    # M√≥dulos para superusers
    if user.is_superuser:
        modules.extend([
            {
                'name': 'Usuarios',
                'description': 'Gesti√≥n de usuarios del sistema',
                'url': '/admin/users/user/',
                'icon': 'üë•',
                'color': 'bg-indigo-500',
                'key': 'system_users'
            },
            {
                'name': 'Administraci√≥n',
                'description': 'Panel completo de administraci√≥n',
                'url': '/modulos/administracion/',
                'icon': '‚öôÔ∏è',
                'color': 'bg-black',
                'key': 'admin_panel'
            },
            {
                'name': 'API Docs',
                'description': 'Documentaci√≥n de la API REST',
                'url': '/api/docs/',
                'icon': 'üìö',
                'color': 'bg-cyan-500',
                'key': 'api_docs'
            }
        ])
    
    return modules